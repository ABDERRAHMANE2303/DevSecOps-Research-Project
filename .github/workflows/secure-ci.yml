name: Secure PHP CI Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

permissions:
  contents: read
  actions: read
  security-events: write

concurrency:
  group: ${{ github.ref }}
  cancel-in-progress: true

jobs:
  security-checks:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'

      - name: Install dependencies
        run: composer install --no-interaction --prefer-dist --no-progress

      # âœ… Code Quality
      - name: PHP_CodeSniffer (PSR12)
        run: vendor/bin/phpcs --standard=PSR12 app || true

      - name: PHPStan Analysis
        run: vendor/bin/phpstan analyse --level=max app || true

      - name: Dependency Audit
        run: composer audit --no-interaction || true

      # âœ… Static Application Security Testing (SAST)
      - name: Semgrep Security Scan
        uses: returntocorp/semgrep-action@v1
        with:
          config: "p/php" # built-in PHP security rules
          output: semgrep-report.json
          json: true
        continue-on-error: true

      # âœ… Dependency Vulnerability Scanning
      - name: OWASP Dependency Check
        uses: dependency-check/Dependency-Check_Action@main
        with:
          project: "PHP App"
          scan: "."
          format: "HTML"
          out: "dependency-check-report"
        continue-on-error: true

      # âœ… Secrets Scanning
      - name: Secret Scan (Gitleaks)
        uses: gitleaks/gitleaks-action@v2
        with:
          config-path: .github/gitleaks.toml
          fail: true
          report-format: json
          report-path: gitleaks-report.json
        continue-on-error: true

      # âœ… Docker Security
      - name: Dockerfile Lint
        uses: hadolint/hadolint-action@v2
        with:
          dockerfile: Dockerfile

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Build Docker image
        uses: docker/build-push-action@v4
        with:
          context: .
          push: false
          tags: myapp:${{ github.sha }}

      - name: Container scan with Trivy
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: myapp:${{ github.sha }}
          format: json
          output: trivy-results.json
          severity: CRITICAL,HIGH
          ignore-unfixed: true
          exit-code: 1
        continue-on-error: true

      # âœ… Infrastructure as Code Security
      - name: Infrastructure scan (tfsec)
        uses: aquasecurity/tfsec-action@v1.0.0
        with:
          args: --format json --out tfsec-results.json
        continue-on-error: true

      # ðŸ“Š Governance & Reporting
      - name: Upload Security Reports
        uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: |
            semgrep-report.json
            dependency-check-report/
            trivy-results.json
            tfsec-results.json
            gitleaks-report.json
        if: always()
