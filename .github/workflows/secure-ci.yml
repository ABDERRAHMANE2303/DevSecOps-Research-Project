name: Secure PHP CI Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

permissions:
  contents: read
  actions: read
  security-events: write

concurrency:
  group: ${{ github.ref }}
  cancel-in-progress: true

jobs:
  security-checks:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'

      - name: Cache Composer
        uses: actions/cache@v4
        with:
          path: ~/.cache/composer
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: |
            ${{ runner.os }}-composer-

      - name: Install dependencies
        run: composer install --no-interaction --prefer-dist --no-progress

      - name: PHP_CodeSniffer (PSR12) if installed
        run: |
          if [ -x vendor/bin/phpcs ]; then
            vendor/bin/phpcs --standard=PSR12 app || true
          else
            echo "phpcs not installed"
          fi

      - name: PHPStan Analysis if installed
        run: |
          if [ -x vendor/bin/phpstan ]; then
            vendor/bin/phpstan analyse --level=max app || true
          else
            echo "phpstan not installed"
          fi

      - name: Dependency Audit (composer)
        run: composer audit --no-interaction || true

      - name: Semgrep Security Scan (produce SARIF)
        run: |
          python3 -m pip install --user semgrep
          export PATH="$HOME/.local/bin:$PATH"
          semgrep --version
          semgrep --config p/php --sarif --output semgrep.sarif . || true

      - name: Build Docker image (for container scan)
        run: |
          docker build -t myapp:${{ github.sha }} . || true

      - name: Container scan with Trivy (produce SARIF)
        run: |
          mkdir -p trivy-output
          docker run --rm -v /var/run/docker.sock:/var/run/docker.sock -v "${{ github.workspace }}/trivy-output":/output aquasecurity/trivy:latest \
            image --format sarif --output /output/trivy-results.sarif myapp:${{ github.sha }} || true

      - name: Infrastructure scan (tfsec produce SARIF)
        run: |
          docker run --rm -v "${{ github.workspace }}":/src aquasecurity/tfsec:latest /src --format sarif --out /src/tfsec-results.sarif || true

      - name: Optional: OWASP Dependency-Check (HTML/XML report)
        run: |
          mkdir -p dependency-check-report
          docker run --rm -v "${{ github.workspace }}":/src -v "${{ github.workspace }}/dependency-check-report":/report owasp/dependency-check:latest \
            --project "PHP App" --scan /src --format ALL --out /report || true

      - name: Optional: Secret Scan (Gitleaks - docker)
        run: |
          docker run --rm -v "${{ github.workspace }}":/repo zricethezav/gitleaks:latest detect \
            -s /repo -R -o /repo/gitleaks-report.json || true

      - name: Ensure SARIF files exist (avoid upload errors)
        run: |
          touch semgrep.sarif || true
          mkdir -p trivy-output
          touch trivy-output/trivy-results.sarif || true
          touch tfsec-results.sarif || true
          # dependency-check.sarif not generated â€” left out unless you convert it

      - name: Upload SARIF to GitHub Code Scanning
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: |
            semgrep.sarif
            trivy-output/trivy-results.sarif
            tfsec-results.sarif

      - name: Upload Security Reports (artifacts)
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-reports
          path: |
            semgrep.sarif
            trivy-output/trivy-results.sarif
            tfsec-results.sarif
            dependency-check-report/
            gitleaks-report.json