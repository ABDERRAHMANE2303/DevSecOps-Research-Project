name: Secure PHP CI Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

permissions:
  contents: read
  actions: read
  security-events: write

concurrency:
  group: ${{ github.ref }}
  cancel-in-progress: true

jobs:
  security-checks:
    runs-on: ubuntu-latest
    env:
      PHP_PATHS: "app database"   # PHP lives here in your repo

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'

      - name: Cache Composer
        uses: actions/cache@v4
        with:
          path: ~/.cache/composer
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: ${{ runner.os }}-composer-

      - name: Install deps
        run: composer install --no-interaction --prefer-dist --no-progress

      # ---------- PHP quality ----------
      - name: PHPCS (PSR12)
        run: |
          if [ -x vendor/bin/phpcs ]; then
            vendor/bin/phpcs --standard=PSR12 $PHP_PATHS || true
          fi
      - name: PHPStan
        run: |
          if [ -x vendor/bin/phpstan ]; then
            vendor/bin/phpstan analyse --level=max $PHP_PATHS || true
          fi
      - name: Composer Audit
        run: composer audit --no-interaction || true

      # ---------- Semgrep (broad, PHP only) ----------
      - name: Semgrep SAST
        run: |
          python3 -m pip install --user semgrep
          export PATH="$HOME/.local/bin:$PATH"
          semgrep --sarif --output semgrep-results.sarif \
            --config p/owasp-top-ten \
            --config p/security-audit \
            --config p/php \
            --config p/secrets \
            .
          # ensure we didn't produce an empty or broken SARIF
          jq -e '.runs[0].results' semgrep-results.sarif >/dev/null
      - name: Upload Semgrep
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: semgrep-results.sarif
          category: semgrep

      # ---------- Trivy (image + fs fallback) ----------
      - name: Build image
        if: ${{ hashFiles('Dockerfile') != '' }}
        run: docker build -t myapp:${{ github.sha }} .

      - name: Trivy image scan
        if: ${{ hashFiles('Dockerfile') != '' }}
        run: |
          docker run --rm -v /var/run/docker.sock:/var/run/docker.sock -v "${{ github.workspace }}":/w aquasec/trivy:latest image \
            --scanners vuln --severity CRITICAL,HIGH,MEDIUM \
            --format sarif --output /w/trivy-results.sarif myapp:${{ github.sha }}
          jq -e '.runs[0].results' trivy-results.sarif >/dev/null

      - name: Trivy fs fallback
        if: ${{ hashFiles('trivy-results.sarif') == '' }}
        run: |
          docker run --rm -v "${{ github.workspace }}":/w aquasec/trivy:latest fs \
            --scanners vuln --severity CRITICAL,HIGH,MEDIUM \
            --format sarif --output /w/trivy-results.sarif /w
          jq -e '.runs[0].results' trivy-results.sarif >/dev/null
      - name: Upload Trivy
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: trivy-results.sarif
          category: trivy

      # ---------- Trivy config (Dockerfile & docker-compose, optional) ----------
      - name: Trivy config scan
        if: ${{ hashFiles('Dockerfile') != '' || hashFiles('docker-compose*.yml') != '' }}
        run: |
          docker run --rm -v "${{ github.workspace }}":/w aquasec/trivy:latest config \
            --format sarif --output /w/trivy-config.sarif /w
          jq -e '.runs[0].results' trivy-config.sarif >/dev/null
      - name: Upload Trivy config
        if: ${{ hashFiles('Dockerfile') != '' || hashFiles('docker-compose*.yml') != '' }}
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: trivy-config.sarif
          category: trivy-config

      # ---------- tfsec (Terraform present in your repo) ----------
      - name: tfsec
        if: ${{ hashFiles('terraform/**/*.tf') != '' }}
        run: |
          mkdir -p tfsec-out
          docker run --rm -v "${{ github.workspace }}":/src -v "${{ github.workspace }}/tfsec-out":/out tfsec/tfsec:latest /src/terraform \
            --format sarif --out /out/tfsec-results.sarif
          jq -e '.runs[0].results' tfsec-out/tfsec-results.sarif >/dev/null
      - name: Upload tfsec
        if: ${{ hashFiles('terraform/**/*.tf') != '' }}
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: tfsec-out/tfsec-results.sarif
          category: tfsec

      # ---------- Ansible ----------
      - name: ansible-lint
        if: ${{ hashFiles('ansible/**/*.yml') != '' }}
        run: |
          python3 -m pip install --user ansible ansible-lint yamllint
          export PATH="$HOME/.local/bin:$PATH"
          ansible-lint ansible -p || true

      # ---------- Gitleaks (respect config; scans history) ----------
      - name: Gitleaks
        run: |
          docker run --rm -v "${{ github.workspace }}":/repo zricethezav/gitleaks:latest detect \
            -s /repo -c /repo/.gitleaks.toml \
            --report-format json --report-path /repo/gitleaks-report.json
          python3 - << 'EOF'
          import json
          d=[]
          try: d=json.load(open("gitleaks-report.json"))
          except: pass
          res=[{"ruleId":x.get("RuleID","secret"),"level":"error",
                "message":{"text":x.get("Description","Secret detected")},
                "locations":[{"physicalLocation":{"artifactLocation":{"uri":x.get("File","unknown")},
                "region":{"startLine":x.get("StartLine",1)}}}]} for x in d]
          sarif={"version":"2.1.0","runs":[{"tool":{"driver":{"name":"Gitleaks"}},"results":res}]}
          open("gitleaks-results.sarif","w").write(json.dumps(sarif,indent=2))
          print("converted", len(res), "findings")
          EOF
          jq -e '.runs[0].results' gitleaks-results.sarif >/dev/null
      - name: Upload Gitleaks
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: gitleaks-results.sarif
          category: gitleaks

      # ---------- Hadolint ----------
      - name: Hadolint
        if: ${{ hashFiles('Dockerfile') != '' }}
        run: docker run --rm -v "${{ github.workspace }}":/d hadolint/hadolint:v2.12.0 hadolint /d/Dockerfile || true

      # ---------- Artifacts + summary ----------
      - name: Upload Security Reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-reports
          path: |
            semgrep-results.sarif
            trivy-results.sarif
            trivy-config.sarif
            tfsec-out/
            gitleaks-report.json
            gitleaks-results.sarif

      - name: Security Summary
        if: always()
        run: |
          python3 - << 'EOF'
          import json,os
          def c(p):
            try: return len(json.load(open(p)).get("runs",[{}])[0].get("results",[]))
            except: return 0
          semgrep=c("semgrep-results.sarif")
          trivy=c("trivy-results.sarif")
          trivy_cfg=c("trivy-config.sarif")
          tfsec=c("tfsec-out/tfsec-results.sarif")
          gitleaks=c("gitleaks-results.sarif")
          total=sum([semgrep,trivy,trivy_cfg,tfsec,gitleaks])
          md=f"""# ðŸ”’ Security Scan Summary

          **Total Security Findings:** {total}

          | Tool | Scope | Findings |
          |------|-------|----------|
          | Semgrep | PHP SAST | {semgrep} |
          | Trivy | Image/FS vulns | {trivy} |
          | Trivy (config) | Docker/Compose misconfig | {trivy_cfg} |
          | tfsec | Terraform IaC | {tfsec} |
          | Gitleaks | Secrets (incl. history) | {gitleaks} |
          """
          open(os.environ["GITHUB_STEP_SUMMARY"],"w").write(md)
          EOF
