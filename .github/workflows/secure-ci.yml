name: Secure PHP CI Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

permissions:
  contents: read
  actions: read
  security-events: write

concurrency:
  group: ${{ github.ref }}
  cancel-in-progress: true

jobs:
  security-checks:
    runs-on: ubuntu-latest

    steps:
      # ðŸ§© Checkout source
      - name: Checkout repository
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4.1.7

      # ðŸ§© PHP setup
      - name: Setup PHP
        uses: shivammathur/setup-php@c541c155eee45413f5b09a52248675b1a2575231 # v2.31.1
        with:
          php-version: '8.2'

      # ðŸ§© Install project dependencies
      - name: Install dependencies
        run: composer install --no-interaction --prefer-dist --no-progress

      # âœ… Code Quality Checks
      - name: PHP_CodeSniffer (PSR12)
        run: vendor/bin/phpcs --standard=PSR12 app || true

      - name: PHPStan Analysis
        run: vendor/bin/phpstan analyse --level=max app || true

      - name: Dependency Audit
        run: composer audit --no-interaction || true

      # âœ… Static Application Security Testing (SAST)
      - name: Semgrep Security Scan
        uses: returntocorp/semgrep-action@713efdd345f3035192eaa63f56867b88e63e4e5d # v1.95.0
        with:
          config: "p/php" # built-in PHP security rules
          output: semgrep-report.json
          json: true
        continue-on-error: true

      # âœ… Dependency Vulnerability Scanning
      - name: OWASP Dependency Check
        uses: dependency-check/Dependency-Check_Action@8e1519gaddf4d5ae0e229a04fb7a620c23e26de0 # v1.1.0
        with:
          project: "PHP App"
          scan: "."
          format: "HTML"
          out: "dependency-check-report"
        continue-on-error: true

      # âœ… Secrets Scanning
      - name: Secret Scan (Gitleaks)
        uses: gitleaks/gitleaks-action@cb7149a9b57195b609dc6c81f1de26901952797a # v2.3.6
        with:
          config-path: .github/gitleaks.toml
          fail: true
          report-format: json
          report-path: gitleaks-report.json
        continue-on-error: true

      # âœ… Docker Security
      - name: Dockerfile Lint
        uses: hadolint/hadolint-action@54c9adbab1582c2ef04b2016b760714a4bfde3cf # v3.1.0
        with:
          dockerfile: Dockerfile

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@988b5a0280414f521da01fcc63a27aeeb4b104db # v3.6.1

      - name: Build Docker image
        uses: docker/build-push-action@5cd11c3a4ced054e52742c5fd54dca954e0edd85 # v6.7.0
        with:
          context: .
          push: false
          tags: myapp:${{ github.sha }}

      - name: Container scan with Trivy
        uses: aquasecurity/trivy-action@6e7b7d1fd3e4fef0c5fa8cce1229c54b2c9bd0d8 # v0.24.0
        with:
          image-ref: myapp:${{ github.sha }}
          format: json
          output: trivy-results.json
          severity: CRITICAL,HIGH
          ignore-unfixed: true
          exit-code: 1
        continue-on-error: true

      # âœ… Infrastructure as Code Security
      - name: Infrastructure scan (tfsec)
        uses: aquasecurity/tfsec-action@b466648d6e39e7c75324f25d83891162a721f2d6 # v1.0.3
        with:
          args: --format json --out tfsec-results.json
        continue-on-error: true

      # ðŸ“Š Governance & Reporting
      - name: Upload Security Reports
        uses: actions/upload-artifact@50769540e7f4bd5e21e526ee35c689e35e0d6874 # v4.4.0
        with:
          name: security-reports
          path: |
            semgrep-report.json
            dependency-check-report/
            trivy-results.json
            tfsec-results.json
            gitleaks-report.json
        if: always()