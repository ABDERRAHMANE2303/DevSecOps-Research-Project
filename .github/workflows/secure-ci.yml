name: Secure PHP CI Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

permissions:
  contents: read
  actions: read
  security-events: write

concurrency:
  group: ${{ github.ref }}
  cancel-in-progress: true

jobs:
  security-checks:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'

      - name: Cache Composer
        uses: actions/cache@v4
        with:
          path: ~/.cache/composer
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: |
            ${{ runner.os }}-composer-

      - name: Install dependencies
        run: composer install --no-interaction --prefer-dist --no-progress

      - name: PHP_CodeSniffer (PSR12)
        run: |
          if [ -x vendor/bin/phpcs ]; then
            vendor/bin/phpcs --standard=PSR12 app || true
          else
            echo "phpcs not installed"
          fi

      - name: PHPStan Analysis
        run: |
          if [ -x vendor/bin/phpstan ]; then
            vendor/bin/phpstan analyse --level=max app || true
          else
            echo "phpstan not installed"
          fi

      - name: Dependency Audit
        run: composer audit --no-interaction || true

      # ===== SEMGREP WITH SARIF OUTPUT =====
      - name: Semgrep Security Scan
        run: |
          python3 -m pip install --user semgrep
          export PATH="$HOME/.local/bin:$PATH"
          semgrep --version
          semgrep --config p/php --sarif --output semgrep-results.sarif . || true

      - name: Upload Semgrep results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: "always() && hashFiles('semgrep-results.sarif') != ''"
        with:
          sarif_file: semgrep-results.sarif
          category: semgrep

      # ===== TRIVY WITH SARIF OUTPUT =====
      - name: Build Docker image
        run: |
          if [ -f Dockerfile ]; then
            docker build -t myapp:${{ github.sha }} . || echo "Docker build failed"
          else
            echo "No Dockerfile found"
          fi

      - name: Container scan with Trivy
        run: |
          # Run Trivy and save directly to workspace
          docker run --rm \
            -v /var/run/docker.sock:/var/run/docker.sock \
            -v "${{ github.workspace }}":/workspace \
            aquasecurity/trivy:latest image \
            --scanners vuln \
            --format sarif \
            --output /workspace/trivy-results.sarif \
            --severity CRITICAL,HIGH \
            myapp:${{ github.sha }} || true

          # Check if file was created
          if [ -f trivy-results.sarif ]; then
            echo "âœ“ Trivy SARIF created successfully"
            ls -lh trivy-results.sarif
          else
            echo "âš  Trivy SARIF not created, creating empty SARIF"
            cat > trivy-results.sarif <<'EOSARIF'
          {
            "version": "2.1.0",
            "$schema": "https://raw.githubusercontent.com/oasis-tcs/sarif-spec/master/Schemata/sarif-schema-2.1.0.json",
            "runs": [{
              "tool": {
                "driver": {
                  "name": "Trivy",
                  "version": "latest"
                }
              },
              "results": []
            }]
          }
          EOSARIF
          fi

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: "always() && hashFiles('trivy-results.sarif') != ''"
        with:
          sarif_file: trivy-results.sarif
          category: trivy-container

      # ===== TFSEC WITH SARIF OUTPUT =====
      - name: Infrastructure scan (tfsec)
        run: |
          mkdir -p tfsec-output
          # Use the official tfsec image and write SARIF into tfsec-output
          docker run --rm \
            -v "${{ github.workspace }}":/src \
            -v "${{ github.workspace }}/tfsec-output":/out \
            tfsec/tfsec:latest /src \
            --format sarif --out /out/tfsec-results.sarif || true

          # Verify or create fallback SARIF
          if [ -f tfsec-output/tfsec-results.sarif ]; then
            echo "âœ“ tfsec SARIF created successfully"
            ls -lh tfsec-output/tfsec-results.sarif
          else
            echo "âš  tfsec SARIF not created, creating empty SARIF"
            cat > tfsec-output/tfsec-results.sarif <<'EOSARIF'
          {
            "version": "2.1.0",
            "$schema": "https://raw.githubusercontent.com/oasis-tcs/sarif-spec/master/Schemata/sarif-schema-2.1.0.json",
            "runs": [{
              "tool": {
                "driver": {
                  "name": "tfsec",
                  "version": "latest"
                }
              },
              "results": []
            }]
          }
          EOSARIF
          fi

      - name: Check tfsec SARIF exists
        id: tfsec-check
        run: |
          if [ -f tfsec-output/tfsec-results.sarif ]; then
            echo "tfsec=true" >> $GITHUB_OUTPUT
          else
            echo "tfsec=false" >> $GITHUB_OUTPUT
          fi

      - name: Upload tfsec results to GitHub Security
        if: "steps.tfsec-check.outputs.tfsec == 'true'"
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: tfsec-output/tfsec-results.sarif
          category: tfsec

      # ===== GITLEAKS WITH SARIF CONVERSION (FIXED) =====
      - name: Secret Scan (Gitleaks)
        run: |
          docker run --rm \
            -v "${{ github.workspace }}":/repo \
            zricethezav/gitleaks:latest detect \
            -s /repo \
            --report-format json \
            --report-path /repo/gitleaks-report.json \
            --no-git || true

          # Check if report was created
          if [ -f gitleaks-report.json ]; then
            echo "âœ“ Gitleaks report created"
            ls -lh gitleaks-report.json
          else
            echo "âš  No gitleaks report, creating empty file"
            echo "[]" > gitleaks-report.json
          fi

      - name: Convert Gitleaks to SARIF
        if: always()
        run: |
          python3 << 'EOF'
          import json, os

          src = "gitleaks-report.json"
          dst = "gitleaks-results.sarif"

          # Read the gitleaks report
          if os.path.exists(src):
              with open(src) as f:
                  content = f.read().strip()
                  # Handle empty or invalid JSON
                  if not content or content == "[]":
                      data = []
                  else:
                      data = json.loads(content)
          else:
              print(f"âš  {src} not found, creating empty results")
              data = []

          # Convert to SARIF
          results = []
          for finding in data:
              results.append({
                  "ruleId": finding.get("RuleID", "secret-detected"),
                  "level": "error",
                  "message": {"text": finding.get("Description", "Secret detected")},
                  "locations": [{
                      "physicalLocation": {
                          "artifactLocation": {"uri": finding.get("File", "unknown")},
                          "region": {"startLine": finding.get("StartLine", 1)}
                      }
                  }]
              })

          sarif = {
              "version": "2.1.0",
              "$schema": "https://raw.githubusercontent.com/oasis-tcs/sarif-spec/master/Schemata/sarif-schema-2.1.0.json",
              "runs": [{
                  "tool": {
                      "driver": {
                          "name": "Gitleaks",
                          "version": "latest"
                      }
                  },
                  "results": results
              }]
          }

          with open(dst, "w") as f:
              json.dump(sarif, f, indent=2)

          print(f"âœ“ Wrote {dst} with {len(results)} findings")
          EOF

          # Verify the file was created
          if [ -f gitleaks-results.sarif ]; then
            echo "âœ“ SARIF file created successfully"
            ls -lh gitleaks-results.sarif
          else
            echo "âœ— Failed to create SARIF file"
            exit 1
          fi

      - name: Upload Gitleaks results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: "always() && hashFiles('gitleaks-results.sarif') != ''"
        with:
          sarif_file: gitleaks-results.sarif
          category: gitleaks

      # ===== DEPENDENCY CHECK =====
      - name: Cache OWASP Dependency Check data
        uses: actions/cache@v4
        with:
          path: dependency-check-data
          key: ${{ runner.os }}-dependency-check-${{ hashFiles('**/composer.lock') }}
          restore-keys: |
            ${{ runner.os }}-dependency-check-

      - name: OWASP Dependency Check
        run: |
          mkdir -p dependency-check-report dependency-check-data
          docker run --rm \
            -v "${{ github.workspace }}":/src \
            -v "${{ github.workspace }}/dependency-check-report":/report \
            -v "${{ github.workspace }}/dependency-check-data":/usr/share/dependency-check/data \
            owasp/dependency-check:latest \
            --project "PHP App" --scan /src --format HTML --out /report || true

      # ===== HADOLINT =====
      - name: Dockerfile Lint (Hadolint)
        run: |
          if [ -f Dockerfile ]; then
            docker run --rm \
              -v "${{ github.workspace }}":/data \
              hadolint/hadolint:v2.12.0 hadolint /data/Dockerfile || true
          else
            echo "No Dockerfile to lint"
          fi

      # ===== UPLOAD ALL REPORTS =====
      - name: Upload Security Reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-reports
          path: |
            semgrep-results.sarif
            dependency-check-report/
            trivy-results.sarif
            tfsec-output/
            gitleaks-report.json
            gitleaks-results.sarif
      
      # ===== SECURITY SUMMARY =====
      - name: Generate Security Summary
        if: always()
        run: |
          python3 << 'EOF'
          import json
          import os
          from pathlib import Path

          def count_sarif_results(file_path):
              """Count findings in a SARIF file"""
              try:
                  if not os.path.exists(file_path):
                      return 0
                  with open(file_path) as f:
                      data = json.load(f)
                      if 'runs' in data and len(data['runs']) > 0:
                          return len(data['runs'][0].get('results', []))
              except Exception as e:
                  print(f"Error reading {file_path}: {e}")
              return 0

          # Count findings from each tool
          semgrep_count = count_sarif_results('semgrep-results.sarif')
          trivy_count = count_sarif_results('trivy-results.sarif')
          tfsec_count = count_sarif_results('tfsec-output/tfsec-results.sarif')
          gitleaks_count = count_sarif_results('gitleaks-results.sarif')

          total_findings = semgrep_count + trivy_count + tfsec_count + gitleaks_count

          # Generate markdown summary
          summary = f"""# ğŸ”’ Security Scan Summary

          ## Overview
          **Total Security Findings:** {total_findings}

          ## Results by Tool

          | Tool | Purpose | Findings |
          |------|---------|----------|
          | ğŸ” Semgrep | SAST (Code Analysis) | {semgrep_count} |
          | ğŸ³ Trivy | Container Vulnerabilities | {trivy_count} |
          | ğŸ—ï¸ tfsec | Infrastructure Security | {tfsec_count} |
          | ğŸ”‘ Gitleaks | Secret Detection | {gitleaks_count} |

          ## Additional Scans Completed
          - âœ… PHP_CodeSniffer (PSR12)
          - âœ… PHPStan Analysis
          - âœ… Composer Dependency Audit
          - âœ… OWASP Dependency Check
          - âœ… Hadolint (Dockerfile Linting)

          ## ğŸ“Š Status
          """

          if total_findings == 0:
              summary += "ğŸ‰ **No security issues found!** All scans passed successfully.\n"
          elif total_findings < 10:
              summary += f"âš ï¸ **{total_findings} issues found.** Review the Security tab for details.\n"
          else:
              summary += f"ğŸš¨ **{total_findings} issues found.** Please review and address critical findings.\n"

          summary += """
          ## ğŸ“ Artifacts
          All detailed reports are available in the `security-reports` artifact.

          ## ğŸ”— Next Steps
          1. Review findings in the [Security tab](../../security/code-scanning)
          2. Check the uploaded artifacts for detailed reports
          3. Address critical and high severity issues first
          """

          # Write to GitHub Step Summary
          github_step_summary = os.environ.get('GITHUB_STEP_SUMMARY')
          if github_step_summary:
              with open(github_step_summary, 'w') as f:
                  f.write(summary)
              print("âœ“ Summary written to GitHub Step Summary")
          else:
              print(summary)
          EOF